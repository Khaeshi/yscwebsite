---
// src/pages/index.astro
// Homepage for Young Starter Club - Migrated from React to Astro for better performance.
// Uses Layout.astro for shared Header/Footer. Dynamic data (testimonials) fetched server-side.
// Interactive elements (e.g., map toggle) use client-loaded React components.

import { TestimonialCard } from "../components/TestimonialCard";
import { Card } from "../components/ui/card";
import { ImageWithFallback } from "../components/figma/ImageWithFallback";
import { ParallaxSection } from "../components/ParallaxSection";
import { Sparkles, Star, Heart, Users, Music, Trophy, Palette, ChefHat, Camera, ArrowRight, CheckCircle2, MessageCircle, HelpCircle } from "lucide-react";
import { format } from 'date-fns';
import { MapToggleButton } from "../components/MapToggleButton";
import { homeimageUrl } from "../config";
import { ChristmasDecoration } from "../components/ChristmasDecor.tsx";
import { EventModal } from "../components/EventModal.tsx"


interface Testimonial {
  name: string;
  role: string;
  content: string;
  rating: number;
  isRecommended: boolean;
  initials: string;
  color: string;
  date: string;
}

// Server-side data fetching for testimonials (moved from useEffect)
let testimonials: Testimonial[] = [];
let loading = true;
let error = null;

try {

  const pageId = process.env.PUBLIC_PAGE_ID;  
  const accessToken = process.env.PUBLIC_FACEBOOK_ACCESS_TOKEN;

  if (!pageId || !accessToken) {
    error = 'Environment variables not loaded. Check your .env file and restart the dev server.';
    loading = false;
  } else {
    const apiVersion = 'v24.0';
    const apiUrl = `https://graph.facebook.com/${apiVersion}/${pageId}/ratings?access_token=${accessToken}&fields=reviewer{name},rating,review_text,created_time,recommendation_type&limit=20`;

    console.log('API URL (masked):', apiUrl.replace(accessToken, '[TOKEN_MASKED]'));

    const response = await fetch(apiUrl);  
    const data = await response.json();
    const reviews = data.data || [];

    const getInitials = (name: string) => name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    const getRandomColor = () => ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-red-500', 'bg-yellow-500'][Math.floor(Math.random() * 5)];

    testimonials = reviews.map((review: any) => {
      const reviewerName = review.reviewer?.name || 'Anonymous';
      const createdDate = review.created_time ? new Date(review.created_time) : new Date();
      return {
        name: reviewerName,
        role: 'Customer',
        content: review.review_text || 'Recommended!',
        rating: review.rating || 5,
        isRecommended: review.recommendation_type === 'positive' || !review.rating,
        initials: getInitials(reviewerName),
        color: getRandomColor(),
        date: format(createdDate, 'MMMM dd, yyyy'),
      };
    });

    loading = false;
  }
} catch (err: any) {
  console.error('Full error response:', err);
  error = 'Failed to load reviews. Check token permissions or try manual curation.';
  loading = false;
}

// Static data (programs, features, stats) - no changes needed
const programs = [
  { id: 'music', title: 'Music Teaching', description: 'Master piano, guitar, violin and more with certified instructors', icon: Music, path: '/music-teaching', color: 'from-purple-500 to-pink-500', bgColor: 'bg-purple-50', textColor: 'text-purple-600', image: 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=600' },
  { id: 'badminton', title: 'Badminton Coaching', description: 'Professional coaching from basic techniques to competitive play', icon: Trophy, path: '/badminton-coaching', color: 'from-blue-500 to-cyan-500', bgColor: 'bg-blue-50', textColor: 'text-blue-600', image: 'https://images.unsplash.com/photo-1626224583764-f87db24ac4ea?w=600' },
  { id: 'arts', title: 'Arts Lessons', description: 'Explore painting, drawing, sculpture and mixed media', icon: Palette, path: '/arts-lessons', color: 'from-pink-500 to-rose-500', bgColor: 'bg-pink-50', textColor: 'text-pink-600', image: 'https://images.unsplash.com/photo-1460661419201-fd4cecdf8a8b?w=600' },
  { id: 'cooking', title: 'Cooking Sessions', description: 'Learn culinary skills and create delicious dishes', icon: ChefHat, path: '/cooking-sessions', color: 'from-orange-500 to-yellow-500', bgColor: 'bg-orange-50', textColor: 'text-orange-600', image: 'https://images.unsplash.com/photo-1556910103-1c02745aae4d?w=600' },
  { id: 'photography', title: 'Photography Classes', description: 'Capture stunning images and master visual storytelling', icon: Camera, path: '/photography-classes', color: 'from-green-500 to-emerald-500', bgColor: 'bg-green-50', textColor: 'text-green-600', image: 'https://images.unsplash.com/photo-1452587925148-ce544e77e70d?w=600' },
];

const features = [
  { icon: Users, title: 'Expert Instructors', description: 'Learn from certified professionals with years of experience' },
  { icon: Heart, title: 'Small Classes', description: 'Personalized attention in intimate learning environments' },
  { icon: Star, title: 'All Ages Welcome', description: 'Programs designed for children, teens, and adults' },
  { icon: CheckCircle2, title: 'Flexible Scheduling', description: 'Choose times that work best for your lifestyle' }
];

const stats = [
  { number: '100+', label: 'Happy Students' },
  { number: '15+', label: 'Years Experience' },
  { number: '15+', label: 'Expert Instructors' },
  { number: '5', label: 'Programs Offered' },
];

---

 {/* Christmas Decorations */}
 <ChristmasDecoration variant="combo" intensity="medium" enabled={true} client:load/>

 {/* Event Modal */}
 <EventModal disabled={true} client:load/>

  <ParallaxSection 
    imageUrl={homeimageUrl};
    className="pt-20 sm:pt-24 lg:pt-32 pb-20 sm:pb-24 lg:pb-32"
    overlayOpacity={0.7}
    client:load
  >
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid lg:grid-cols-2 gap-12 items-center">
        <!-- Left Content -->
        <div class="text-white">
          <div class="inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full mb-6 border border-white/30">
            <Sparkles className="w-4 h-4" />
            <span class="text-sm">Empowering Learners Since 2010</span>
          </div>
          
          <h1 class="text-4xl sm:text-5xl lg:text-6xl mb-6 text-white">
            Discover Your
            <span class="block mt-2 text-yellow-300">Passion & Potential</span>
          </h1>
          
          <p class="text-xl mb-8 text-white/90 leading-relaxed">
            Join Young Starter Club where creativity meets learning! We offer 
            world-class programs in music, sports, arts, cooking, and 
            photography for all ages.
          </p>
          
          <!-- CTA Buttons -->
          <div class="flex flex-wrap gap-4 mb-10">
            <a 
              href="https://www.facebook.com/YSCcommunity" 
              target="_blank" 
              rel="noopener noreferrer" 
              class="inline-flex items-center gap-2 bg-white text-purple-600 hover:bg-yellow-300 hover:text-purple-700 shadow-xl hover:shadow-2xl transition-all duration-300 px-4 py-2 rounded-lg font-medium text-sm"
            >
              <MessageCircle className="w-5 h-5" />
              Get Started Today
            </a>           
            <a 
              href="#programs"
              class="inline-flex items-center gap-2 bg-white text-purple-600 hover:bg-yellow-300 hover:text-purple-700 shadow-xl hover:shadow-2xl transition-all duration-300 px-4 py-2 rounded-lg font-medium text-sm"
              >
              Explore Programs
              <ArrowRight className="w-5 h-5 ml-2" />
            </a>
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-6">
            {stats.map((stat, index) => (
              <div class="text-center">
                <div class="text-3xl font-bold text-yellow-300 mb-1">{stat.number}</div>
                <div class="text-sm text-white/80">{stat.label}</div>
              </div>
            ))}
          </div>
        </div>

        <!-- Right Content - Image Grid -->
        <div class="hidden lg:grid grid-cols-2 gap-4">
          <div class="space-y-4">
            <div class="rounded-2xl overflow-hidden shadow-2xl transform hover:scale-105 transition-transform duration-300">
              <ImageWithFallback
                src="https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=600"
                alt="Music lessons"
                className="w-full h-48 object-cover"
                client:load
              />
            </div>
            <div class="rounded-2xl overflow-hidden shadow-2xl transform hover:scale-105 transition-transform duration-300">
              <ImageWithFallback
                src="https://images.unsplash.com/photo-1460661419201-fd4cecdf8a8b?w=600"
                alt="Art classes"
                className="w-full h-64 object-cover"
                client:load
              />
            </div>
          </div>
          <div class="space-y-4 pt-8">
            <div class="rounded-2xl overflow-hidden shadow-2xl transform hover:scale-105 transition-transform duration-300">
              <ImageWithFallback
                src="https://images.unsplash.com/photo-1626224583764-f87db24ac4ea?w=600"
                alt="Badminton coaching"
                className="w-full h-64 object-cover"
                client:load
              />
            </div>
            <div class="rounded-2xl overflow-hidden shadow-2xl transform hover:scale-105 transition-transform duration-300">
              <ImageWithFallback
                src="https://images.unsplash.com/photo-1556910103-1c02745aae4d?w=600"
                alt="Cooking sessions"
                className="w-full h-48 object-cover"
                client:load
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  </ParallaxSection>

  <!-- Features Strip -->
  <section class="py-12 bg-white border-b">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
        {features.map((feature, index) => (
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center flex-shrink-0">
              <feature.icon className="w-6 h-6 text-white" />
            </div>
            <div>
              <h4 class="mb-1">{feature.title}</h4>
              <p class="text-sm text-muted-foreground">{feature.description}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Programs Section -->
  <section id="programs" class="py-20 bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-16">
        <div class="inline-flex items-center gap-2 bg-purple-100 px-4 py-2 rounded-full mb-4">
          <Sparkles className="w-4 h-4 text-purple-600" />
          <span class="text-sm text-purple-600">What We Offer</span>
        </div>
        <h2 class="mb-4">Explore Our Programs</h2>
        <p class="text-muted-foreground max-w-2xl mx-auto text-lg">
          Choose from our diverse range of programs designed to inspire creativity, build skills, and foster growth
        </p>
      </div>
      
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-7xl mx-auto">
        {programs.map((program) => (
          <a href={program.path} class="group">
            <Card className="h-full overflow-hidden hover:shadow-2xl transition-all duration-300 border-2 hover:border-purple-300">
              <div class="relative h-48 overflow-hidden">
                <ImageWithFallback
                  src={program.image}
                  alt={program.title}
                  className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                  client:load
                />
                <div class={`absolute inset-0 bg-gradient-to-br ${program.color} opacity-40 group-hover:opacity-20 transition-opacity`}></div>
                <div class={`absolute top-4 right-4 w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg`}>
                  <program.icon className={`w-6 h-6 ${program.textColor}`} />
                </div>
              </div>
              
              <div class="p-6">
                <h3 class="mb-2 group-hover:text-purple-600 transition-colors">{program.title}</h3>
                <p class="text-muted-foreground mb-4">{program.description}</p>
                <div class={`inline-flex items-center gap-2 ${program.textColor} font-medium`}>
                  Learn More 
                  <ArrowRight className="w-4 h-4 group-hover:translate-x-2 transition-transform" />
                </div>
              </div>
            </Card>
          </a>
        ))}
      </div>

      <div class="text-center mt-12">
        <p class="text-muted-foreground mb-4">Not sure which program is right for you?</p>
        <a 
          href="/QuizProgram/find-your-program" 
          class="inline-flex items-center gap-2 border border-purple-600 text-purple-600 hover:bg-purple-600 hover:text-white px-6 py-3 rounded-lg font-medium text-sm transition-all"
        >
          <HelpCircle className="w-5 h-5" />
          Take a test now
        </a>
      </div>
    </div>
  </section>

    <!-- Why Choose Us Section -->
    <section class="py-20 bg-white">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid lg:grid-cols-2 gap-12 items-center max-w-6xl mx-auto">
          <!-- Image -->
          <div class="relative">
            <div class="relative rounded-3xl overflow-hidden shadow-2xl">
              <ImageWithFallback
                src="https://images.unsplash.com/photo-1427504494785-3a9ca7044f45?w=800"
                alt="Happy students"
                className="w-full h-[500px] object-cover"
                client:load
              />
            </div>
            <!-- Floating Badge -->
            <div class="absolute -bottom-6 -right-6 bg-gradient-to-br from-purple-600 to-pink-600 text-white p-6 rounded-2xl shadow-2xl">
              <div class="text-3xl font-bold mb-1">11+ Years</div>
              <div class="text-sm opacity-90">of Excellence</div>
            </div>
          </div>
  
          <!-- Content -->
          <div>
            <div class="inline-flex items-center gap-2 bg-purple-100 px-4 py-2 rounded-full mb-6">
              <Heart className="w-4 h-4 text-purple-600" />
              <span class="text-sm text-purple-600">Why Choose Us</span>
            </div>
            
            <h2 class="mb-6">Your Journey to Excellence Starts Here</h2>
            
            <p class="text-muted-foreground mb-8 text-lg">
              At Young Starter Club, we're more than just a learning center. We're a vibrant community dedicated to helping you discover your passions and achieve your goals.
            </p>
  
            <div class="space-y-4 mb-8">
              {[
                'Certified and passionate instructors',
                'State-of-the-art facilities and equipment',
                'Flexible class schedules for all lifestyles',
                'Small class sizes for personalized attention',
                'Proven track record of student success',
                'Supportive and inclusive community'
              ].map((item) => (
                <div class="flex items-center gap-3">
                  <CheckCircle2 className="w-6 h-6 text-green-500 flex-shrink-0" />
                  <span class="text-muted-foreground">{item}</span>
                </div>
              ))}
            </div>
  
            <!-- Map Toggle Button - Uses a client-loaded React component for state -->
            <MapToggleButton client:load />
          </div>
        </div>
      </div>
    </section>
  
    <!-- Animated Google Maps Section - Controlled by MapToggleButton -->
    <div id="map-section" class="overflow-hidden transition-all duration-700 ease-in-out max-h-0 opacity-0">
      <section class="py-12 bg-gradient-to-br from-purple-50 to-pink-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
          <div class="max-w-6xl mx-auto transition-all duration-700 delay-100 -translate-y-8 opacity-0" id="map-content">
            <div class="bg-white rounded-3xl shadow-2xl p-4 border-2 border-purple-200">
              <!-- Responsive Google Maps iframe -->
              <div class="relative overflow-hidden rounded-2xl" style="padding-top: 75%;"> {/* 4:3 Aspect Ratio */}
                <iframe 
                  src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d966.3396427435331!2d121.05020367230219!3d14.348648757664607!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3397d74a7ea51fdf%3A0x76c3eb78c5e87eca!2sYoung%20Starter%20Club!5e0!3m2!1sen!2sph!4v1764236052425!5m2!1sen!2sph" 
                  class="absolute top-0 left-0 w-full h-full border-0" 
                  allowfullscreen={true} 
                  loading="lazy" 
                  referrerpolicy="no-referrer-when-downgrade"
                />
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  
    <!-- Testimonials Section -->
    <section id="testimonials" class="py-20 bg-gradient-to-br from-purple-50 to-pink-50">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="mb-4">What Our Community Says</h2>
          <p class="text-muted-foreground max-w-2xl mx-auto">
            Don't just take our word for it - hear from our happy students and parents!
          </p>
        </div>
        {loading ? (
          <p class="text-center">Loading reviews...</p>
        ) : error ? (
          <p class="text-center text-red-500">{error}</p>
        ) : (
          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
            {testimonials.map((testimonial, index) => (
              <TestimonialCard testimonial={testimonial} client:idle
              />
            ))}
          </div>
        )}
      </div>
    </section>
  
    <!-- CTA Section - Parallax -->
    <ParallaxSection 
      imageUrl={homeimageUrl}
      className="py-10"
      overlayOpacity={0.8}
      client:load
    >
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <Sparkles className="w-12 h-12 mx-auto mb-6 text-yellow-300" />
        <h2 class="mb-6 text-white text-4xl lg:text-5xl">Ready to Begin Your Journey?</h2>
        <p class="mb-8 max-w-2xl mx-auto text-white/90 text-xl">
          Join our vibrant community of learners today. Let's discover your passion together!
        </p>
        <div class="flex flex-wrap gap-4 justify-center">
          <a 
            href="https://www.facebook.com/YSCcommunity" 
            target="_blank" 
            rel="noopener noreferrer" 
            class="inline-flex items-center gap-2 bg-white text-purple-600 hover:bg-yellow-300 hover:text-purple-700 shadow-xl px-6 py-3 rounded-lg font-medium text-sm"
          >
            <MessageCircle className="w-5 h-5 mr-2" />
            Contact Us on Facebook
          </a>        
          <a 
          href="#programs"
          class="inline-flex items-center gap-2 bg-white text-purple-600 hover:bg-yellow-300 hover:text-purple-700 shadow-xl px-6 py-3 rounded-lg font-medium text-sm"
          >
          Browse Programs
          </a>
        </div>
      </div>
    </ParallaxSection>
